## 네트워크 계층(Network Layer)

### 1. 네트워크 계층 개요
- 라우터(router)
  - 포워딩(forwarding): 패킷이 라우터의 입력 링크에 도달했을 때 라우터는 그 패킷을 적절한 출력 링크로 이동시키는 것, 하드웨어에서 실행
  - 라우팅(routing): 송신자가 수신자에게 패킷을 전송할 때 패킷 경로를 결정하는 방법 또는 알고리즘, 소프트웨어에서 실행
  - 라우팅은 제어 영역(control plane)에서, 포워딩은 데이터 영역(data plane)에서 포워딩 테이블을 사이에 두고 상호 작용한다
  - 라우터는 포워딩 테이블에서 패킷의 목적지 주소의 프리픽스(prefix)를 테이블의 엔트리와 대응시켜서 그에 연관된 링크로 내보낸다
    - 최장 프리픽스 대응 규칙(longest prefix matching rule)을 적용한다
    - IP 주소의 앞에서 부터 가장 긴 대응 엔트리를 테이블에서 찾고, 그에 연관된 링크 인터페이스로 패킷을 보낸다

### 2. IPv4
- IPv4 데이터그램 형식
  - ![image](https://github.com/kimho1wq/TIL/assets/15611500/9e49dc3c-44a0-4c75-a6c5-f76c101bad2c)
  - 버전 번호: IPv4: 0100, IPv6: 0110
  - 헤더 길이: IPv4 데이터그램 헤더는 보통 20바이트 이다
  - TTL(Time-to-live)
    - 네트워크에서 데이터그램이 무한히 순환하지 않도록 한다(라우팅 루프)
    - 라우터가 데이터그램을 처리할 때마다(hop을 이동할 때마다) 감소하고, TTL 필드가 0이 되면 라우터가 데이터그램을 폐기한다
  - 프로토콜: 데이터그램이 최종 목적지에 도착했을 때 사용되며 전송 계층의 프로토콜을 명시한다(TCP: 17 or UDP: 6)
  - 헤더 체크섬
    - 데이터그램의 IP 헤더만 체크섬을 수행하고, TCP/UDP는 전체 세그먼트에 대해 체크섬을 수행한다
    - 데이터그램의 비트 오류를 탐지하는데 도움을 주고 라우터는 보통 오류가 검출된 데이터그램을 폐기한다
    - TTL 필드와 옵션 필드의 값은 계속 변경되므로 각 라우터에서 재계산되고 저장되어야 한다
  - 데이터(payload): 전송 계층 세그먼트(TCP or UDP)를 포함하지만 ICMP 메시지와 같은 다른 유형의 데이터를 담기도 한다
- IPv4 데이터그램 단편화(fragmentation) 
  - ![image](https://github.com/kimho1wq/TIL/assets/15611500/383b1b2e-376c-4ce0-9daf-eb7543f5b84f)
  - 링크 계층 프레임이 전달할 수 있는 최대 데이터 양을 MTU(Maximum Transmission Unit)이라 한다
  - 각각의 라우터는 서로 다른 MTU를 가진 링크 계층 프로토콜을 가지기 때문에 IP 데이터그램의 길이보다 출력 링크의 MTU가 작다면 단편화(fragmentation) 해야 한다
  - 각각의 조각(fragment)는 전송 계층에 도달하기 전에 종단 시스템에서 재결합(reassembly)되고, IP 데이터그램 헤더에 있는 식별자, 플래그, 단편화 오프셋은 재결합을 위한 데이터이다
    - 데이터그램의 조각은 출발지와 목적지의 주소, 원본 데이터그램의 식별자 정보를 포함하고 있다
    - 마지막 데이터그램 조각의 플래그 비트는 0, 다른 조각의 플래그 비트는 1이다
    - 오프셋 필드는 조각이 분실되었는지 또는 적절한 순서로 조각을 재결합하기 위해서 사용된다
- IPv4 주소체계
  - 각 IP 주소는 32비트 길이(4바이트)로 2<sup>32</sup>개(대략 40억개) 주소가 사용 가능하다
  - 주소는 일반적으로 각 바이트를 십진수로 표현하고 주소의 다른 바이트와 점(.)으로 구분하는 십진 표기법(dotted-decimal notation)을 사용한다
  - 서브넷(subnet)은 여러 호스들의 인터페이스들과 하나의 라우터 인터페이스로 연결된 네트워크이다
    - ![image](https://github.com/kimho1wq/TIL/assets/15611500/e043c697-2101-49ba-97c1-a91e656c0bf0)
  - 서브넷 마스크(subnet mask)는 서브넷의 주소로, 십진 표기법 주소 옆에 슬래시(/) 다음 숫자로 표시한다 (Ex, 223.1.1.0/24는 32비트 주소의 왼쪽 24비트가 서브넷 주소라는 것을 가리킨다)
  - 클래스 주소체계(classful addressing): CIDR이 채택되기 전에는 서브넷을 A,B,C 클래스 네트워크로 분류하는 방법
    - IP 주소의 서브넷 부분이 A,B,C 클래스 순서대로 정확히 1,2,3 바이트여야 하는 요구사항 때문에 사용성이 떨어짐
  - CIDR(Classless InterDomain Routing): 서브넷 주소체계 표기를 일반화한 것(a.b.c.d/x)으로 이것이 채택되어 사용됨
  - 브로드캐스트 주소(255.255.255.255): 같은 서브넷에 있는 모든 호스트에게 전달되는 주소 
  - ICANN(Internet Corporation for Assigned Names and Numbers) 라는 기관이 IP 주소 할당과 DNS 루트 서버를 관리한다
  - 한 기관이 IP 주소를 얻기 위해서는 ISP로부터 주소 블록을 획득하여, 개별 IP 주소를 기관 내부의 호스트와 라우터 인터페이스에게 할당해야 한다
    - ![image](https://github.com/kimho1wq/TIL/assets/15611500/e30c0f1a-06d0-4d7c-81f1-a250eba7fcce)


### 3. 라우팅 알고리즘
- 송신 측에서부터 수신 측 라우터의 네트워크를 통과하는 경로를 결정하는 알고리즘이다
- 라우팅 알고리즘 분류
  - 중앙 집중형 라우팅 알고리즘: 네트워크 전체에 대한 완전한 정보를 가지고 출발지와 목적지 사이의 최소 비용 경로를 계산한다
  - 분산형 라우팅 알고리즘: 최소 비용 경로의 계산이 라우터들에 의해 반복적이고 분산된 방식으로 수행된다
  - 정적 라우팅 알고리즘: 경로의 변경이 느리고 사람이 직접 링크에 대한 비용을 수정한다
  - 동적 라우팅 알고리즘: 네트워크 트래픽 부하나 토폴로지(topology) 변화에 따라 라우터가 자체적으로 경로를 변경한다
- LS(Link State) 알고리즘
  - 중앙 집중형 알고리즘에 속하여 모든 라우터(노드)가 모든 링크(간선)의 비용을 알고 있기 때문에 다익스트라(dijkstra) 알고리즘을 이용해 최적의 경로를 계산할 수 있다
  - 한 노드(source node)에서 다른 모든 노드까지의 최적 경로를 계산해 routing table에 저장한다
- DV(Distance Vector) 알고리즘
  - 분산형 알고리즘에 속하여 각 노드는 연결된 이웃 링크의 비용만 알고 있기 때문에 벨만-포드(bellman-ford) 알고리즘을 이용하여 최적의 경로를 계산한다
  - 반복적이고 비 동적이며 분산적 알고리즘으로 이웃 노드끼리 라우팅 테이블의 정보를 교환해 최적의 경로를 갱신하는 방법이다



### 4. DHCP(Dynamic Host Configuration Protocol)
- DHCP 개요
  - 네트워크 관리자는 라우터 안에 IP 주소를 할당하고, 호스트에 IP 주소는 수동으로 구성하지 않고 DHCP를 사용한다
  - DHCP는 호스트가 네트워크에 접속하고자 할 때마다 동일한 또는 임시의 IP 주소를 할당하고, 서브넷 마스크, 첫 번째 홉 라우터(디폴트 게이트웨이) 주소나 로컬 DNS 서버 주소와 같은 추가 정보를 얻게 해준다
  - 플러그 앤 플레이(plug-and-play) 또는 제로 구성(zero-configuration) 프로토콜 이라고도 한다
- DHCP 프로토콜 4단계 과정
  - ![image](https://github.com/kimho1wq/TIL/assets/15611500/e3ac6a92-d5c1-494c-9b4b-2bc41ed0a0fe)
  1. DHCP 서버 발견(server discovery): 새로운 호스트가 DHCP 발견 메시지(목적지:브로드캐스트, 출발지:0.0.0.0, 포트:67)로 서버를 찾는다
  2. DHCP 서버 제공(server offer): DHCP 서버는 DHCP 제공 메시지(목적지:브로드캐스트, 출발지:DHCP 서버 주소, yiaddrr:제공하는 주소, Lifetime:제공 시간)로 클라이언트에게 응답한다
  3. DHCP 요청(request): 클라이언트는 받은 메시지중 하나를 선택해 제공자에게 DHCP 요청 메시지(목적지: DHCP 서버 주소, 출발지:0.0.0.0, yiaddrr: 사용하고자 하는 주소)로 응답한다
  4. DHCP ACK: 서버는 요청된 파라미터를 확인하는 DHCP ACK 메시지로 응답한다


### 5. NAT(Network Address Translation)
- NAT 개요
  - ![image](https://github.com/kimho1wq/TIL/assets/15611500/5e053244-673c-4056-86ff-d84a6f95c7bf)
  - 네트워크 주소 변환(NAT)이 가능한 라우터는 WAN측의 IP+포트를 LAN측의 사설망 IP로 변환하여 전달해주는 방식
  - NAT 라우터에서 NAT 변환 테이블(translation table)을 사용하여 매핑시킨다
  - 라우터는 ISP의 DHCP 서버로부터 주소를 얻고, 홈 네트워크의 주소 공간에서 DHCP 서버를 싱행하여 각 컴퓨터에게 주소를 제공한다


### 6. ICMP(Internet Control Message Protocol)
- ICMP 개요
  - ICMP(인터넷 제어 메시지 프로토콜)은 호스트와 라우터가 서로 간에 네트워크 계층 정보를 주고받기 위해 사용된다
  - 가장 전형적인 사용 형태는 오류 보고이고, 라우터가 호스트에게 오류가 발생했음을 알리기 위해서 ICMP 메시지를 만들어 보낸다
  - ICMP 메시지는 IP 페이로드(payload)에 담겨 전송되므로 상위 계층 프로토콜과 비슷하고, 타입과 코드에 관련된 정보가 담겨있다
  - ![image](https://github.com/kimho1wq/TIL/assets/15611500/28640259-1852-48ca-9826-094b254c5683)





















